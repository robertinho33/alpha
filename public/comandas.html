<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Comandas - Salão de Beleza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 10% auto; padding: 20px; width: 300px; }
    </style>
</head>
<body>

    <div class="container mt-4">
        <h1 class="text-primary">Fechamento de Comandas</h1>
        <h2 class="text-primary mt-4">Comandas Registradas</h2>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Data</th>
                    <th>Serviços</th>
                    <th>Total (R$)</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="tabelaComandas"></tbody>
        </table>
    </div>

    <div class="container mt-4">
        <h1 class="text-primary">Registro de Comandas</h1>
        <form id="registroForm" class="card pro-demo">
            <div class="card-body">
                <div class="mb-3">
                    <label for="cliente" class="text-dark">Nome do Cliente</label>
                    <input type="text" id="cliente" name="cliente" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="text-dark">Serviços e Profissionais</label>
                    <div id="servicos-container"></div>
                    <button type="button" class="btn btn-secondary mt-2" id="addServiceBtn">Adicionar Serviço</button>
                </div>

                <div class="mb-3">
                    <label for="total" class="text-dark">Total da Comanda (R$)</label>
                    <input type="text" id="total" name="total" class="form-control" readonly>
                </div>

                <div class="mb-3">
                    <label for="data" class="text-dark">Data do Atendimento</label>
                    <input type="date" id="data" name="data" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="observacoes" class="text-dark">Observações</label>
                    <textarea id="observacoes" name="observacoes" class="form-control"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">Registrar Comanda</button>
            </div>
        </form>
    </div>

    <div id="modalPagamento" class="modal-overlay">
        <div class="modal-content">
            <h5 class="text-primary">Fechar Comanda</h5>
            <form id="formPagamento">
                <div class="mb-3">
                    <label for="formaPagamento" class="form-label">Forma de Pagamento</label>
                    <select id="formaPagamento" class="form-control">
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                        <option value="Cartão de Débito">Cartão de Débito</option>
                        <option value="Pix">Pix</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Fechar</button>
                <button type="button" class="btn btn-secondary" id="cancelPaymentBtn">Cancelar</button>
            </form>
        </div>
    </div>

   <!-- <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            updateDoc, 
            doc, 
            query, 
            where 
        } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB3785y6GPsFH7xuwfwjcBoPjvUfE3kSMw",
            authDomain: "alphaglamstart.firebaseapp.com",
            projectId: "alphaglamstart",
            storageBucket: "alphaglamstart.appspot.com",
            messagingSenderId: "885178660314",
            appId: "1:885178660314:web:1bb3a78be9fa7fdcdefce3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Dados fixos
        const SERVICOS_DISPONIVEIS = [
            { tipo: "Corte", profissionais: ["Ana", "Carlos"] },
            { tipo: "Coloração", profissionais: ["Fernanda", "Marcos"] },
            { tipo: "Manicure", profissionais: ["Beatriz", "Juliana"] },
            { tipo: "Massagem", profissionais: ["Ricardo", "Tatiane"] }
        ];

        // Gerenciamento de Comandas
        class ComandaManager {
            static async carregarComandas() {
                try {
                    const today = new Date();
                    const startOfDay = new Date(today.setHours(0, 0, 0, 0));
                    const endOfDay = new Date(today.setHours(23, 59, 59, 999));
                    const q = query(
                        collection(db, "comandas"), 
                        where("criadoEm", ">=", startOfDay), 
                        where("criadoEm", "<=", endOfDay)
                    );
                    const querySnapshot = await getDocs(q);
                    const tabela = document.getElementById("tabelaComandas");
                    tabela.innerHTML = "";

                    querySnapshot.forEach(docSnap => {
                        const comanda = docSnap.data();
                        const row = this.criarLinhaComanda(docSnap.id, comanda);
                        tabela.appendChild(row);
                    });
                } catch (error) {
                    console.error("Erro ao carregar comandas:", error);
                }
            }

            static criarLinhaComanda(id, comanda) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${comanda.cliente}</td>
                    <td>${comanda.data}</td>
                    <td>${this.formatarServicos(comanda.servicos)}</td>
                    <td>R$${comanda.total?.toFixed(2) || '0.00'}</td>
                    <td>${comanda.status || 'Pendente'}</td>
                    <td><button class="btn btn-success fecharComanda" data-id="${id}" data-status="${comanda.status}">Fechar</button></td>
                `;
                
                row.querySelector('.fecharComanda').addEventListener('click', () => {
                    if (comanda.status === "aberta") {
                        ModalPagamento.abrir(doc(db, "comandas", id));
                    }
                });
                return row;
            }

            static formatarServicos(servicos) {
                return servicos?.map(s => `${s.profissional} - ${s.servico} (R$${s.valor?.toFixed(2) || '0.00'})`).join('<br>') || 'N/A';
            }

            static async registrarComanda(formData) {
                try {
                    await addDoc(collection(db, "comandas"), {
                        ...formData,
                        status: "aberta",
                        criadoEm: new Date()
                    });
                    return true;
                } catch (error) {
                    console.error("Erro ao salvar no Firestore:", error);
                    return false;
                }
            }
        }

        // Gerenciamento do Modal de Pagamento
        class ModalPagamento {
            static modal = document.getElementById('modalPagamento');
            static form = document.getElementById('formPagamento');

            static abrir(docRef) {
                this.modal.style.display = 'block';
                this.form.onsubmit = async (event) => {
                    event.preventDefault();
                    await this.fecharComanda(docRef);
                };
            }

            static async fecharComanda(docRef) {
                try {
                    await updateDoc(docRef, {
                        status: "fechada",
                        formaPagamento: document.getElementById('formaPagamento').value,
                        fechadoEm: new Date()
                    });
                    this.modal.style.display = 'none';
                    await ComandaManager.carregarComandas();
                } catch (error) {
                    console.error("Erro ao fechar comanda:", error);
                }
            }

            static fechar() {
                this.modal.style.display = 'none';
            }
        }

        // Gerenciamento de Serviços
        class ServicoManager {
            static adicionarServico(container) {
                const id = `servico-${Date.now()}`;
                const div = document.createElement("div");
                div.classList.add("d-flex", "gap-2", "mb-2");
                div.innerHTML = `
                    <select class="form-control servico-select" data-id="${id}">
                        <option value="">Selecione um serviço</option>
                        ${SERVICOS_DISPONIVEIS.map(s => `<option value="${s.tipo}">${s.tipo}</option>`).join("")}
                    </select>
                    <select class="form-control profissional-select" id="profissional-${id}">
                        <option value="">Selecione um profissional</option>
                    </select>
                    <input type="number" class="form-control valor" placeholder="Valor (R$)" step="0.01">
                    <button type="button" class="btn btn-danger remove-btn">X</button>
                `;
                container.appendChild(div);

                div.querySelector('.servico-select').addEventListener('change', (e) => this.atualizarProfissionais(e.target, id));
                div.querySelector('.valor').addEventListener('input', this.calcularTotal);
                div.querySelector('.remove-btn').addEventListener('click', (e) => this.removerServico(e.target));
            }

            static atualizarProfissionais(select, id) {
                const tipo = select.value;
                const profissionalSelect = document.getElementById(`profissional-${id}`);
                const servico = SERVICOS_DISPONIVEIS.find(s => s.tipo === tipo);
                profissionalSelect.innerHTML = "<option value=''>Selecione um profissional</option>";
                if (servico) {
                    servico.profissionais.forEach(p => {
                        profissionalSelect.innerHTML += `<option value="${p}">${p}</option>`;
                    });
                }
                this.calcularTotal();
            }

            static calcularTotal() {
                const total = Array.from(document.querySelectorAll(".valor"))
                    .reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
                document.getElementById("total").value = total.toFixed(2);
            }

            static removerServico(button) {
                button.parentElement.remove();
                this.calcularTotal();
            }

            static getServicos() {
                const servicos = [];
                document.querySelectorAll("#servicos-container div").forEach(div => {
                    const servico = div.children[0].value;
                    const profissional = div.children[1].value;
                    const valor = parseFloat(div.children[2].value);
                    if (servico && profissional && valor) {
                        servicos.push({ servico, profissional, valor });
                    }
                });
                return servicos;
            }
        }

        // Inicialização
        function inicializar() {
            // Eventos do formulário
            document.getElementById('addServiceBtn').addEventListener('click', () => {
                ServicoManager.adicionarServico(document.getElementById("servicos-container"));
            });

            document.getElementById('registroForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const formData = {
                    cliente: document.getElementById("cliente").value,
                    data: document.getElementById("data").value,
                    observacoes: document.getElementById("observacoes").value,
                    total: parseFloat(document.getElementById("total").value),
                    servicos: ServicoManager.getServicos()
                };

                const sucesso = await ComandaManager.registrarComanda(formData);
                if (sucesso) {
                    alert("Comanda registrada com sucesso!");
                    document.getElementById("registroForm").reset();
                    document.getElementById("servicos-container").innerHTML = "";
                    await ComandaManager.carregarComandas();
                } else {
                    alert("Erro ao registrar comanda.");
                }
            });

            document.getElementById('cancelPaymentBtn').addEventListener('click', () => ModalPagamento.fechar());

            // Carregar comandas iniciais
            ComandaManager.carregarComandas();
        }

        window.onload = inicializar;
    </script>-->
    <!-- [O resto do HTML permanece o mesmo até o final do body] -->
    <script type="module" src="../src/js/main.js"></script>
</body>
</html>
