<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Salão - UserPluss</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Menu Lateral -->
    <div class="sidebar">
        <h3 class="text-center">UserPluss Admin</h3>
        <ul class="nav flex-column">
            <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link d-none" href="funcionarios.html" id="funcionariosLink">Funcionários</a></li>
            <li class="nav-item"><a class="nav-link d-none" href="servicos.html" id="servicosLink">Serviços</a></li>
            <li class="nav-item"><a class="nav-link d-none" href="agenda.html" id="agendaLink">Agenda</a></li>
            <li class="nav-item"><a class="nav-link active" href="cadastro-salao.html" id="cadastroSalaoLink">Cadastro de Salão</a></li>
            <li class="nav-item"><a class="nav-link" href="perfil.html">Perfil</a></li>
            <li class="nav-item"><a class="nav-link text-danger" href="#" id="logoutButton">Sair</a></li>
        </ul>
    </div>

    <!-- Conteúdo Principal -->
    <div class="content">
        <h1>Cadastro de Novo Salão</h1>
        <div class="card p-4">
            <form id="cadastroSalaoForm">
                <h3>Dados do Salão</h3>
                <div class="mb-3">
                    <label for="nomeSalao" class="form-label">Nome do Salão</label>
                    <input type="text" id="nomeSalao" class="form-control" placeholder="Nome do Salão" required>
                </div>
                <div class="mb-3">
                    <label for="enderecoSalao" class="form-label">Endereço do Salão</label>
                    <input type="text" id="enderecoSalao" class="form-control" placeholder="Endereço do Salão" required>
                </div>

                <h3>Dados do Administrador do Salão</h3>
                <div class="mb-3">
                    <label for="nomeAdmin" class="form-label">Nome</label>
                    <input type="text" id="nomeAdmin" class="form-control" placeholder="Nome completo" required>
                </div>
                <div class="mb-3">
                    <label for="emailAdmin" class="form-label">E-mail</label>
                    <input type="email" id="emailAdmin" class="form-control" placeholder="email@exemplo.com" required autocomplete="email">
                </div>
                <div class="mb-3">
                    <label for="telefoneAdmin" class="form-label">Telefone</label>
                    <input type="tel" id="telefoneAdmin" class="form-control" placeholder="(XX) XXXXX-XXXX" required>
                </div>
                <div class="mb-3">
                    <label for="senhaAdmin" class="form-label">Senha Temporária</label>
                    <input type="password" id="senhaAdmin" class="form-control" placeholder="Crie uma senha temporária" required autocomplete="new-password">
                </div>
                <div class="mb-3">
                    <label for="aniversarioAdmin" class="form-label">Data de Nascimento</label>
                    <input type="date" id="aniversarioAdmin" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary">Cadastrar Salão</button>
            </form>
            <p id="mensagemSucesso" class="text-success mt-2 d-none"></p>
            <p id="mensagemErro" class="text-danger mt-2 d-none"></p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="./src/js/firebase.js"></script>
    <script type="module">
        import { auth, db } from './src/js/firebase.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { createUserWithEmailAndPassword, sendPasswordResetEmail, fetchSignInMethodsForEmail } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { doc, setDoc, collection, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Verificar se o usuário atual é super administrador
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
                return;
            }

            const userDoc = await getDoc(doc(db, 'users', user.uid));
            if (!userDoc.exists() || !userDoc.data().isSuperAdmin) {
                alert('Acesso não autorizado. Apenas o super administrador pode cadastrar salões.');
                window.location.href = 'dashboard.html';
                return;
            }

            // Exibir links do menu para o super administrador
            document.getElementById('funcionariosLink').classList.remove('d-none');
            document.getElementById('servicosLink').classList.remove('d-none');
            document.getElementById('agendaLink').classList.remove('d-none');
            document.getElementById('cadastroSalaoLink').classList.remove('d-none');
        });

        // Lógica de cadastro de novo salão
        document.getElementById('cadastroSalaoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const nomeSalao = document.getElementById('nomeSalao').value;
            const enderecoSalao = document.getElementById('enderecoSalao').value;
            const nomeAdmin = document.getElementById('nomeAdmin').value;
            const emailAdmin = document.getElementById('emailAdmin').value;
            const telefoneAdmin = document.getElementById('telefoneAdmin').value;
            const senhaAdmin = document.getElementById('senhaAdmin').value;
            const aniversarioAdmin = document.getElementById('aniversarioAdmin').value;
            const mensagemSucesso = document.getElementById('mensagemSucesso');
            const mensagemErro = document.getElementById('mensagemErro');

            try {
                // Verificar se o e-mail já está em uso
                const signInMethods = await fetchSignInMethodsForEmail(auth, emailAdmin);
                if (signInMethods.length > 0) {
                    mensagemErro.textContent = 'Este e-mail já está em uso. Use outro e-mail.';
                    mensagemErro.classList.remove('d-none');
                    mensagemSucesso.classList.add('d-none');
                    return;
                }

                // Criar o administrador do salão no Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, emailAdmin, senhaAdmin);
                const user = userCredential.user;

                // Enviar e-mail para redefinir a senha
                await sendPasswordResetEmail(user, {
                    url: `${window.location.origin}/index.html`,
                });

                // Criar documento do administrador no Firestore
                const salonId = user.uid; // Usar o UID do administrador como ID do salão
                await setDoc(doc(db, 'users', user.uid), {
                    nome: nomeAdmin,
                    email: emailAdmin,
                    telefone: telefoneAdmin,
                    aniversario: aniversarioAdmin,
                    isAdmin: true,
                    isSuperAdmin: false,
                    isColaborador: false,
                    salonId: salonId,
                    createdAt: new Date().toISOString(),
                });

                // Criar o salão no Firestore
                await setDoc(doc(db, 'salons', salonId), {
                    adminId: user.uid,
                    nome: nomeSalao,
                    endereco: enderecoSalao,
                    createdAt: new Date().toISOString(),
                });

                // Criar subcoleções iniciais
                await setDoc(doc(collection(db, 'salons', salonId, 'funcionarios')), {});
                await setDoc(doc(collection(db, 'salons', salonId, 'servicos')), {});
                await setDoc(doc(collection(db, 'salons', salonId, 'agendamentos')), {});

                mensagemSucesso.textContent = 'Salão cadastrado com sucesso! Um e-mail foi enviado ao administrador para redefinir a senha.';
                mensagemSucesso.classList.remove('d-none');
                mensagemErro.classList.add('d-none');
                document.getElementById('cadastroSalaoForm').reset();
            } catch (error) {
                console.error('Erro ao cadastrar:', error);
                mensagemErro.classList.remove('d-none');
                mensagemSucesso.classList.add('d-none');
                if (error.code === 'auth/email-already-in-use') {
                    mensagemErro.textContent = 'Este e-mail já está em uso. Use outro e-mail.';
                } else if (error.code === 'auth/unauthorized-continue-uri') {
                    mensagemErro.textContent = 'Erro: O domínio atual não está autorizado. Por favor, contate o administrador do sistema.';
                } else {
                    mensagemErro.textContent = 'Erro ao cadastrar: ' + error.message;
                }
            }
        });

        // Botão de logout
        document.getElementById('logoutButton').addEventListener('click', (e) => {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        });
    </script>
</body>
</html>